---
title: Draft Template
summary: Summary Draft Template
categories: category
tags: tag1 tag2
date: 2021-01-01 09:09:09 +0000
cover: https://example.com/img.png
redirect_from: 
- /old1-route
- /old2-route
layout: post
---


## Pre-Requisites

Make sure that you have **openssl**

```sh
openssl version -a
```

To setup 2-way ssl (mutual authentication) you need:
- Certificate Authority (CA)
- Server Certificate (generated and used on your server)
- the public certificate of the second server that you want to accept requests from


## Certificate Authority (CA)

What is [certificate authority](https://en.wikipedia.org/wiki/Certificate_authority)?
> In cryptography, a certificate authority or certification authority (CA) is an entity that issues digital certificates. A digital certificate certifies the ownership of a public key by the named subject of the certificate. This allows others (relying parties) to rely upon signatures or on assertions made about the private key that corresponds to the certified public key.

Having this mentioned, we need an authority which validates our certificates. Here are two options, to grant yourself the authority and self-sign certificates or use a trusted authority. In the following lines I'll describe the process of signing the certificate

### Using self-signed certificates

Now we should generate a new Certificate Authority self signed, run the following:

```sh
$ openssl req -new -x509 -days 9999 -keyout ca-key.pem -out ca-crt.pem
```

Note!! You can remove `-days 9999` to make the certificate to don't expire.

Then the terminal prompts the following:

```sh
Generating a 2048 bit RSA private key
................................................+++
....................................................+++
writing new private key to 'ca-key.pem'
Enter PEM pass phrase: YOUR_CA_PASSWORD
Verifying - Enter PEM pass phrase: YOUR_CA_PASSWORD
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:RO
State or Province Name (full name) []:Romania
Locality Name (eg, city) [Default City]:Bucharest
Organization Name (eg, company) [Default Company Ltd]:Cmevo Digital SRL
Organizational Unit Name (eg, section) []:devops
Common Name (eg, your name or your server's hostname) []:cmevo.com
Email Address []:contact@cmevo.com
```

Now you can check the files generated

```sh
$ ls -l

ca-crt.pem
ca-key.pem
```

### Using trusted signed certificates

To use a trusted signed certificate, simply search on internet, if you prefer privacy I recommend [Duckduckgo](https://duckduckgo.com/) & [Firefox](https://www.mozilla.org/en-US/firefox/new/).

Doesn't matter which provider you choose, to get the public certificate you need to provide a private key, generated on your server. To do this [go to ](link_here)

## Server Certificate

Generate the key for server

```sh
$ openssl genrsa -out server-key.pem 4096
Generating RSA private key, 4096 bit long modulus
.......................................................................................++
...........................................................++
e is 65537 (0x10001)
```

Generate a Server Certificate Signing Request

```
$ openssl req -new -key server-key.pem -out server-csr.pem
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:RO
State or Province Name (full name) []:Bucharest
Locality Name (eg, city) [Default City]:^C
[ec2-user@api custom_cert]$ openssl req -new -key server-key.pem -out server-csr.pem
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:RO
State or Province Name (full name) []:Romania
Locality Name (eg, city) [Default City]:Bucharest
Organization Name (eg, company) [Default Company Ltd]:Cmevo Digital SRL
Organizational Unit Name (eg, section) []:devops
Common Name (eg, your name or your server's hostname) []:private-api.cmevo.com
Email Address []:contact@cmevo.com

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:SERVER_PASSWORD
An optional company name []:
```

Now let's the certificate with previously generated CA certificate

```sh
$ openssl x509 -req -days 9999 -in server-csr.pem -CA ca-crt.pem -CAkey ca-key.pem -CAcreateserial -out server-crt.pem
Signature ok
subject=/C=RO/ST=Romania/L=Bucharest/O=Cmevo Digital SRL/OU=devops/CN=private-api.cmevo.com/emailAddress=bogdan.militaru@cmevo.com
Getting CA Private Key
Enter pass phrase for ca-key.pem:YOUR_CA_PASSWORD
```

Look at our files:

```sh
$ ls
ca-crt.pem  ca-crt.srl  ca-key.pem  server-crt.pem  server-csr.pem  server-key.pem
```

Oookk guys, let's check our certificate

```sh
$ openssl verify -CAfile ca-crt.pem server-crt.pem
server-crt.pem: OK
```

## Client Certificate

Hey boys, let's stay a bit here, because I want to explain you what is next. A lot of tutorials out there doesn't specify exactly what is this about and how it works and for me was very confusing.


## Nginx configuration

Oh, we're almost there boys. Let's configure finally the nginx.

```conf

```